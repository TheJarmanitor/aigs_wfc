{% load static %}
<link rel="stylesheet" href="{% static 'assets/style.css' %}">
<style>
body {
    background-image: url("{% static 'assets/drog.png' %}");
    background-color: rgba(255,255,255,0.8);
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-blend-mode: overlay;
}
</Style>
<div class="main-container">
    <h1>CPPN-NEAT2WFC:<br><br>{{ version }}</h1>
    <div id="image-container" class="grid-container">
        {% for i in n %}
        {% if version == "B" %}
        <img src="{% static 'assets/generated/B/img_' %}{{i}}_wfc.png" id="image-{{i}}" data-id={{i}} class="clickable-image" alt="Django image" onclick="toggleImageSelection(this)">
        {% else %}
        <img src="{% static 'assets/generated/img_' %}X_{{i}}_wfc.png" id="image-{{i}}" data-id={{i}} class="clickable-image" alt="Django image" onclick="toggleImageSelection(this)">
        {% endif %}
        {% endfor %}
    </div>
    <div class="button-container">
        <button onclick="sendSelectedImages()">Mutate</button>
        <button onclick="downloadSelected()">Save selected images</button>
        <button style="margin-left: 2em; background:#c05555;" onclick="reloadPage()">Restart</button>
    </div>
</div>

<script>
    // Array to hold selected image IDs
    let selectedImages = [];
    let allImages = {{ n|safe }};
    const maxSelectedImages = 4;  // Maximum number of images that can be selected
    const version = "{{ version }}";
    const user_id = {{ user_id }};

    // Function to toggle selection of an image
    function toggleImageSelection(imageElement) {
        const imageId = imageElement.getAttribute('data-id');

        if (selectedImages.includes(imageId)) {
            // Deselect the image (remove from selected images array)
            selectedImages = selectedImages.filter(id => id !== imageId);
            imageElement.classList.remove('selected');
        } else {
            // Select the image (add to selected images array)
            selectedImages.push(imageId);
            imageElement.classList.add('selected');
            if (selectedImages.length > maxSelectedImages) {
                const idToRemove = selectedImages.shift();
                const imageToRemove = document.getElementById('image-' + idToRemove);
                imageToRemove.classList.remove('selected');
            }
            
        }
    }

    // Function to send the selected images to the server
    function sendSelectedImages() {
        if (selectedImages.length === 0) {
            alert('Please select at least one image.');
            return;
        }

        // Send the selected images using AJAX (or fetch)
        const csrftoken = '{{ csrf_token }}';

        fetch("{% url 'cwapp:process_images' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken  // Django's CSRF protection
            },
            body: JSON.stringify({ 
                selected_images: selectedImages, 
                all_images: allImages,
                version: version,
                user_id: user_id
            })  // Send the selected and all images
        })
        .then(response => response.json())
        .then(data => {
            // Dynamically update the images with the new ones
            updateImages(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function updateImages(data) {
    const newImages = data.new_images;
    const imageContainer = document.getElementById('image-container');
    imageContainer.innerHTML = '';  // Clear old images
    
    // Set fixed dimensions to avoid squishing
    const placeholderWidth = 100;  // Adjust according to your image size
    const placeholderHeight = 100; // Adjust according to your image size

    if("{{ version }}" == "A" && user_id != data.user_id){
        console.error("User id mismatch: " + user_id + " != " + data.user_id);
    }
    
    // Add new images dynamically
    newImages.forEach((index) => {
        const img = document.createElement('img');
        if ("{{ version }}" == "B"){
            img.src = "{% static 'assets/generated/B/img_' %}" + index + "_wfc.png";
        }
        else{
            console.log("user id: " + user_id);
            img.src = "{% static 'assets/generated/img_' %}" + user_id + '_' + index + "_wfc.png";
        }
        img.alt = 'Generated Image ' + index;
        img.classList.add('image');
        img.id = 'image-' + index;
        img.setAttribute('data-id', index);
        img.style.width = placeholderWidth + 'px';  // Set the placeholder width
        img.style.height = placeholderHeight + 'px';  // Set the placeholder height
        img.onclick = function() { toggleImageSelection(img); };  // Bind the click event
        
        // Once the image is loaded, adjust its dimensions automatically
        img.onload = function() {
            img.style.width = '';  // Remove inline width to allow natural size
            img.style.height = ''; // Remove inline height to allow natural size
        };
        
        imageContainer.appendChild(img);

        //refatch image, bcs the name of src is same and it wouldnt be updated
        if ("{{ version }}" == "A")
            refetchImage(img.id, img.src);
    });

    allImages = newImages;
    selectedImages = [];
}

    function reloadPage(){
        location.reload();
    }

    function downloadSelected(){
        // Download images
        const selectedImages = document.querySelectorAll('.selected');
        selectedImages.forEach((img) => {
            const imageId = img.getAttribute('data-id');
            const imageUrl = img.src;
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = 'image_' + imageId + '.png';
            link.click();
        });

        
    }

    function refetchImage(imageId, imageUrl) {
    // Get the current image element by its ID
    const imageElement = document.getElementById(imageId);
    
    if (imageElement) {
        // Append a timestamp to the image URL to force re-fetching
        const timestamp = new Date().getTime();
        imageElement.src = `${imageUrl}?t=${timestamp}`;
    } else {
        console.error("Image element not found!");
    }
}
    
</script>